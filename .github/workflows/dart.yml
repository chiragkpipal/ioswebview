name: Build and Sign iOS App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Set up CocoaPods
      run: |
        sudo gem install cocoapods
        cd ios
        pod install --repo-update

    - name: Set up Keychain
      run: |
        security create-keychain -p ${{ secrets.KEYCHAIN_PASSWORD }} build.keychain
        security import <(echo ${{ secrets.IOS_DISTRIBUTION_CERT }} | base64 --decode) -P "" -A
        security set-key-partition-list -S apple-tool:,apple: -s -k ${{ secrets.KEYCHAIN_PASSWORD }} build.keychain
        security default-keychain -s build.keychain

    - name: Install Fastlane
      run: gem install fastlane

    - name: Build and Sign iOS App
      run: |
        cd ios
        fastlane build

    - name: Upload IPA to GitHub Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: Runner.ipa
        path: ios/build/Runner.ipa
